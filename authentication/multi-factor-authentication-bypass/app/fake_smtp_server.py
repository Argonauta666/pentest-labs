from smtpd import SMTPServer
from asyncore import loop as asyncore_loop
from email import message_from_string
from email.header import decode_header
from time import gmtime, strftime

class CustomSMTPServer(SMTPServer):
	def process_message(self, peer, mailfrom, rcpttos, data, mail_options=None,rcpt_options=None):
		try:
			message = message_from_string(data.decode('utf-8'))
			subject = ''
			for encoded_string, charset in decode_header(message.get('Subject')):
				if charset is not None:
					subject += encoded_string.decode(charset)
				else:
					subject += encoded_string
			with open("emails.txt", "a+") as file:
				file.write("{} {} {} {}\n".format(mailfrom,",".join(rcpttos),strftime("%Y-%m-%d %H:%M:%S", gmtime()),subject))
		except:
			pass
		return

server = CustomSMTPServer(('0.0.0.0', 1025), None)
asyncore_loop()