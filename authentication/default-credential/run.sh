image_name='vulnerable_app'

sudo apt update -y

if which curl >/dev/null; then
    echo -e '[X] curl comamnd -> good'
else
    echo -e '[X] curl comamnd -> download'
	sudo apt install -y curl
fi

if which docker >/dev/null; then
    echo -e '[X] docker comamnd -> good'
else
    echo -e '[X] docker comamnd -> download'
	sudo apt install -y linux-headers-$(uname -r) docker.io
fi

container_pid=$(sudo docker ps -q --filter ancestor=$image_name)
if [ -n "$container_pid" ]; then
	sudo docker stop $container_pid > /dev/null
fi

wait_on_web_interface () {
	until $(curl --silent --head --fail http://0.0.0.0:5142/ --output /dev/null); do
	sleep 5
	done
	echo -e '[X] vulnerable_app -> good'
}

wait_on_web_interface &
sudo docker build -t vulnerable_app .
sudo docker run -p 5142:5142 -it vulnerable_app
container_pid=$(sudo docker ps -q --filter ancestor=$image_name)
if [ -n "$container_pid" ]; then
	sudo docker stop $container_pid > /dev/null
fi

#sudo docker rmi $(docker images |grep $image_name)
